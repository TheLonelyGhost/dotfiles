#!/usr/bin/env bash
PATH="/usr/local/bin:$PATH"

set -euo pipefail

if [ $# -gt 0 ]; then
  target="$1"; shift
else
  printf '%b: unspecified environment. Please specify it as the first argument.\n' "${RED}ERROR${NORMAL}" 1>&2
  exit 1
fi

case "$target" in
  work)
    printf '%b: environment "%s" has deployment disabled\n' "${RED}ERROR${NORMAL}" "$target" 1>&2
    exit 1
    ;;
  *)
    var_name="${target^^}_WIKI_SITE_ID"
    site_id="${!var_name}"
    if [ -z "${site_id}" ]; then
      printf '%b: unknown environment "%s"\n' "${RED}ERROR${NORMAL}" "$target" 1>&2
      exit 1
    fi
    ;;
esac

netlify_cmd="$(command -v netlify 2>/dev/null)"
if [ -z "$netlify_cmd" ] || [ ! -x "$netlify_cmd" ]; then
  netlify_cmd="${HOME}/.npm-packages/bin/netlify"
fi

if [ -z "$netlify_cmd" ] || [ ! -x "$netlify_cmd" ]; then
  printf '%b: netlify command is not installed\n' "${RED}ERROR${NORMAL}" 1>&2
  exit 1
fi

if [ -z "$site_id" ]; then
  printf '%b: Netlify site id was not set\n' "${RED}ERROR${NORMAL}" 1>&2
  exit 1
fi

if [ -e "${HOME}/Documents/${target}-notes" ]; then
  {
    cd "${HOME}/Documents/${target}-notes" || exit 1
    "$netlify_cmd" deploy --site-id "${site_id}" --path .
  }
fi
