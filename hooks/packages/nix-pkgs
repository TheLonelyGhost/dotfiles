#!/usr/bin/env bash

set -euo pipefail

PACKAGES=()
function __add_package() {
  PACKAGES+=("$1")
}

has_command() {
  if command -v "$1" 1>/dev/null 2>/dev/null; then
    return 0
  else
    return 1
  fi
}
is_nix_command() {
  if command -v "$1" 2>/dev/null | grep -qFe '.nix-profile'; then
    return 0
  else
    return 1
  fi
}

__add_if_not_nix() {
  if ! nix-env -q | grep -Fe "$1" 1>/dev/null 2>/dev/null; then
    # if ! is_nix_command "$1"; then
    __add_package "$1"
  fi
}

if ! (has_command 'nix-env' && has_command 'nix-channel'); then
  . "${HOME}/.nix-profile/etc/profile.d/nix.sh"
fi

nix-channel --update
nix-env --delete-generations 14d
nix-store --gc --print-dead

# GNU Utils on macOS
__add_if_not_nix 'gnugrep'
__add_if_not_nix 'gnused'
__add_if_not_nix 'gnutar'
__add_if_not_nix 'gnumake'
__add_if_not_nix 'parallel'
__add_if_not_nix 'netcat-gnu'
__add_if_not_nix 'less'
__add_if_not_nix 'openssh'
__add_if_not_nix 'rsync'
__add_if_not_nix 'unzip'
__add_if_not_nix 'tree'
__add_if_not_nix 'which'
__add_if_not_nix 'findutils'
__add_if_not_nix 'wget'
__add_if_not_nix 'bash'
__add_if_not_nix 'bash-completion'
__add_if_not_nix 'zsh'
__add_if_not_nix 'zsh-completions'
__add_if_not_nix 'gzip'
__add_if_not_nix 'gnutls'
__add_if_not_nix 'binutils'
__add_if_not_nix 'coreutils'
__add_if_not_nix 'git'
__add_if_not_nix 'tmux'
__add_if_not_nix 'neovim'
__add_if_not_nix 'openssl'
__add_if_not_nix 'gnupg'
__add_if_not_nix 'dos2unix'
__add_if_not_nix 'universal-ctags'
__add_if_not_nix 'libyaml'
# __add_if_not_nix 'qt-full'
__add_if_not_nix 'jq'
__add_if_not_nix 'sqlite'
__add_if_not_nix 'graphicsmagick'
__add_if_not_nix 'ffmpeg'
__add_if_not_nix 'gifsicle'
__add_if_not_nix 'python3.7-mitmproxy'
# __add_if_not_nix 'phantomjs'
__add_if_not_nix 'nodejs'
__add_if_not_nix 'rcm'
__add_if_not_nix 'terraform'
__add_if_not_nix 'direnv'
__add_if_not_nix 'silver-searcher'
__add_if_not_nix 'rclone'
__add_if_not_nix 'chruby'
__add_if_not_nix 'bat'
__add_if_not_nix 'elixir'
__add_if_not_nix 'libwebp'
__add_if_not_nix 'optipng'
__add_if_not_nix 'jpegoptim'
# __add_if_not_nix 'crystal'  # Currently broken

# Other utils
if [[ "$(uname -s)" != "Darwin" ]]; then
  __add_if_not_nix 'go'  # `go build` is broken on MacOS (unless with CGO_ENABLED=0)
  __add_if_not_nix 'xclip'
  __add_if_not_nix 'tcpdump' # Only available on Linux

  # __add_if_not_nix 'alacritty'  # Currently broken
else
  __add_if_not_nix 'reattach-to-user-namespace'
  __add_if_not_nix 'procps'  # Provides `watch` command
  # __add_if_not_nix 'xquartz'
fi

if [ ${#PACKAGES[@]} -eq 0 ]; then
  cat <<MSG

PACKAGES: none

MSG
else
  cat <<MSG

PACKAGES: ${PACKAGES[@]}

MSG

  nix-env -i "${PACKAGES[@]}"
fi

__message 'Nix packages in need of updating:'
nix-env -u --dry-run
