#!/bin/bash
set -euo pipefail

if [ ! -e /usr/include/zlib.h ] && command -v 'defaults' 1>/dev/null 2>/dev/null; then
  # Fix issue in macOS Mojave where XCode doesn't install headers for installed libraries
  if [[ $(defaults read loginwindow SystemVersionStampAsString) =~ 10.14* ]]; then
    sudo installer -pkg /Library/Developer/CommandLineTools/Packages/macOS_SDK_headers_for_macOS_10.14.pkg -target /
  fi
fi

brew update

brew bundle --file=- <<EOF
tap "homebrew/services"
tap "caskroom/cask"
tap "caskroom/fonts"
tap "chef/chef"
tap "habitat-sh/habitat"
tap "theseal/ssh-askpass"

# NOTE: Casks up front so we'll be prompted by sudo right away, then wait for rest of user-scoped installations
cask "font-twitter-color-emoji"
cask "google-chrome"
# cask "vagrant"  # latest version of vagrant is borked, as of v2.2.1. Last known good is v2.0.4
cask "alfred"
cask "virtualbox"
cask "virtualbox-extension-pack"
cask "iterm2"
cask "docker"
cask "telegram"
cask "evernote"
cask "keepassxc"
cask "firefox"
cask "simplenote"
cask "chefdk"
cask "hab"

brew "keychain"
brew "ssh-askpass"
brew "dark-mode"
brew "shellcheck"
brew "go"

# Databases
brew "postgres", restart_service: true
brew "redis", restart_service: true
brew "mongodb", restart_service: true
EOF
