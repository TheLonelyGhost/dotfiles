#!/bin/bash
set -e

PACKAGES=()
function __add_package() {
  PACKAGES+=("$1")
}

# ----------------------
# | Add packages below |
# ----------------------

__add_package 'github-macros'
__add_package 'asciinema'
__add_package 'flake8'
__add_package 'isort'
__add_package 'simplenote_jekyll'
__add_package 'mkdocs'
__add_package 'pipenv'
__add_package 'yamllint'
__add_package 'pre-commit'
__add_package 'vim-vint'

if ! command -v 'mitmproxy' &>/dev/null; then
  # Homebrew has some funky stuff and it's preferable to install it that route, whenever possible
  __add_package 'mitmproxy'
fi

# ------------------------
# | Done adding packages |
# ------------------------

cat <<MSG

PACKAGES: ${PACKAGES[@]}

MSG

pip3 install --user pipx | awk '{ if($0 !~ /already (installed|satisfied)/) {print} }' || true
pip3 install --upgrade --user pipx | awk '{ if($0 !~ /already (up-to-date|satisfied)/) {print} }' || true
hash -r

if command -v pipx &>/dev/null; then
  for pkg in "${PACKAGES[@]}"; do
    pipx install "${pkg}" | grep -v 'already seems to be installed' || true
  done
  pipx upgrade-all || true
else
  printf '%s\n' "Something went wrong and pipx is not in your PATH" 1>&2
  printf '%s\n' "Try this hook again" 1>&2
  exit 1
fi
