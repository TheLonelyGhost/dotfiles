#!/bin/bash
set -e

HOOK_DIR="${0%/*}/../"
source "${HOOK_DIR}/lib/base.sh"

PACKAGES=()
function __add_package() {
  PACKAGES+=("$1")
}

# ----------------------
# | Add packages below |
# ----------------------

__add_package 'github-macros'
__add_package 'oc-replacement'
__add_package 'asciinema'
__add_package 'awsume'
__add_package 'docker-compose'
if ! is_wsl; then
  __add_package 'trackerjacker'
fi
__add_package 'b2'
__add_package 'httpie'
__add_package 'glances'
__add_package 'flake8'
__add_package 'isort'
__add_package 'simplenote_jekyll'
__add_package 'mkdocs'
__add_package 'pipenv'
__add_package 'yamllint'
__add_package 'pre-commit'
__add_package 'vim-vint'

if ! command -v 'mitmproxy' &>/dev/null && ! is_wsl; then
  # Homebrew has some funky stuff and it's preferable to install it that route, whenever possible
  __add_package 'mitmproxy'
fi

# ------------------------
# | Done adding packages |
# ------------------------

cat <<MSG

PACKAGES: ${PACKAGES[@]}

MSG

if ! printf '%s\n' "$PATH" | tr -s ":" "\n" | grep -qFe "${HOME}/.pyenv/shims" &>/dev/null; then
  PATH="${HOME}/.pyenv/shims:${PATH}"
  hash -r
fi

python3 -m pip install --upgrade --user pip

python3 -m pip install --user pipx | awk '{ if($0 !~ /already (installed|satisfied)/) {print} }' || true
python3 -m pip install --upgrade --user pipx | awk '{ if($0 !~ /already (up-to-date|satisfied)/) {print} }' || true
hash -r

if command -v pipx &>/dev/null; then
  for pkg in "${PACKAGES[@]}"; do
    pipx install "${pkg}" | grep -v 'already seems to be installed' || true
  done
  pipx upgrade-all || true
else
  printf '%s\n' "Something went wrong and pipx is not in your PATH" 1>&2
  printf '%s\n' "Try this hook again" 1>&2
  exit 1
fi
