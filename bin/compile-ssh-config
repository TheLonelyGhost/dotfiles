#!/usr/bin/env bash

set -euo pipefail

LOG_LEVEL=${LOG_LEVEL:-7}

__debug() {
  local msg
  msg=$1; shift

  if [ "$LOG_LEVEL" -ge 9 ]; then
    printf '>>  %s\n' "$msg"
  fi
}

__info() {
  local msg
  msg=$1; shift

  if [ "$LOG_LEVEL" -ge 6 ]; then
    printf '>>  %s\n' "$msg"
  fi
}

if [ ! -e "${HOME}/.ssh/config.d" ]; then
  # shellcheck disable=SC2088
  printf 'ERROR: Missing source directory %s\n' '~/.ssh/config.d' 1>&2
  exit 1
fi

if [ -e "${HOME}/.ssh/config" ]; then
  __info 'Backing up ~/.ssh/config as ~/.ssh/config.old'
  cat "${HOME}/.ssh/config" > "${HOME}/.ssh/config.old"
  rm "${HOME}/.ssh/config"
fi

# Initial warning message:
cat <<'EOF' > "${HOME}/.ssh/config"
# vim: ft=sshconfig

#  ____________
# /            \
# |  WARNING!  |
# \____________/
#
# This file is managed by `compile-ssh-config`. Do not manually alter anything here.
# Instead, add or alter files in ~/.ssh/config.d/*
EOF

if [ -e "${HOME}/.ssh/config.d/pre" ]; then
  find "${HOME}/.ssh/config.d/pre" -maxdepth 1 -not -type d | sort | while read -r file; do
    __debug "Reading ${file/${HOME}/~} into ~/.ssh/config"
    printf '\n\n# (from file: %s)\n' "${file/${HOME}/~}" >> "${HOME}/.ssh/config"
    grep -v '# v''im: ' "$file" >> "${HOME}/.ssh/config"
  done
fi

find "${HOME}/.ssh/config.d" -maxdepth 1 -not -type d | sort | while read -r file; do
  __debug "Reading ${file/${HOME}/~} into ~/.ssh/config"
  printf '\n\n# (from file: %s)\n' "${file/${HOME}/~}" >> "${HOME}/.ssh/config"
  grep -v '# v''im: ' "$file" >> "${HOME}/.ssh/config"
done

if [ -e "${HOME}/.ssh/config.d/post" ]; then
  find "${HOME}/.ssh/config.d/post" -maxdepth 1 -not -type d | sort | while read -r file; do
    __debug "Reading ${file/${HOME}/~} into ~/.ssh/config"
    printf '\n\n# (from file: %s)\n' "${file/${HOME}/~}" >> "${HOME}/.ssh/config"
    grep -v '# v''im: ' "$file" >> "${HOME}/.ssh/config"
  done
fi
